<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>ÂÆ∂‰∫ã„ÅÆ„Äå„ÅÑ„Å§„Å†„Å£„ÅëÔºü„ÄçËß£Ê±∫„Åè„Çì</title>
    <style>
        :root {
            /* Default: „Åµ„Çì„Çè„Çä (Soft) */
            --primary-bg: #fffbf5;
            --card-bg: #ffffff;
            --accent-color: #ff9a9e;
            --secondary-accent: #fad0c4;
            --text-main: #5d5d5d;
            --text-light: #8e8e8e;
            --shadow: 0 4px 15px rgba(255, 154, 158, 0.1);
            --radius: 20px;
            --nav-bg: #f0e6dd;
            --slider-bg: #fdfaf7;
        }

        [data-theme="calm"] {
            --primary-bg: #1a1c1e;
            --card-bg: #2d2f31;
            --accent-color: #ffb4b9;
            --secondary-accent: #4a4d51;
            --text-main: #f1f1f1;
            --text-light: #a0a0a0;
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            --nav-bg: #111111;
            --slider-bg: #1a1c1e;
        }

        [data-theme="natural"] {
            --primary-bg: #eef2e7;
            /* More muted, sage-beige green */
            --card-bg: #ffffff;
            --accent-color: #7ba644;
            /* Slightly deeper green for better contrast */
            --secondary-accent: #d3dbca;
            --text-main: #3e4a32;
            --text-light: #6c7a5f;
            --shadow: 0 4px 15px rgba(62, 74, 50, 0.08);
            --nav-bg: #dae2d0;
            --slider-bg: #f5f7f1;
        }

        * {
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px;
        }

        h1 {
            font-size: 1.6rem;
            color: var(--accent-color);
            margin-bottom: 5px;
            line-height: 1.2;
        }

        h1 span {
            display: block;
        }

        h1 .title-sub {
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .icon-btn {
            background: var(--card-bg);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
            border: none;
        }

        .icon-btn:active {
            transform: scale(0.9);
        }

        .icon-btn.active {
            border: 2px solid var(--accent-color);
        }

        .nav-tabs {
            display: flex;
            background: var(--nav-bg);
            padding: 5px;
            border-radius: 25px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 25px;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-light);
        }

        .nav-tab.active {
            background: var(--card-bg);
            color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding-bottom: 100px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        .category-label {
            font-size: 0.65rem;
            color: var(--accent-color);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
            display: block;
        }

        .task-name {
            font-weight: bold;
            font-size: 1.1rem;
            display: block;
            margin-bottom: 6px;
        }

        .task-meta {
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .status-due {
            background: #ffebeb;
            color: #ff6b6b;
        }

        .status-ok {
            background: #e8fbf0;
            color: #2ecc71;
        }

        .status-future {
            background: #f0f0f0;
            color: #888;
        }

        .advice-box {
            font-size: 0.75rem;
            color: var(--text-light);
            font-style: italic;
            margin-top: 10px;
            padding-left: 10px;
            border-left: 3px solid var(--secondary-accent);
            padding-right: 30px;
            /* Space for delete button */
        }

        .btn-delete {
            position: absolute;
            top: 20px;
            right: 15px;
            background: transparent;
            color: var(--text-light);
            font-size: 0.9rem;
            padding: 5px;
            width: auto;
            opacity: 0.4;
            transition: opacity 0.2s, color 0.2s;
            cursor: pointer;
            border: none;
        }

        .btn-delete:hover {
            opacity: 1;
            color: #ff6b6b;
        }

        .slider-section {
            margin: 15px 0;
            background: var(--slider-bg);
            padding: 12px;
            border-radius: 15px;
        }

        .slider-label {
            font-size: 0.75rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-value {
            color: var(--accent-color);
            font-weight: bold;
        }

        .guide-text {
            font-size: 0.65rem;
            color: var(--text-light);
            opacity: 0.7;
            margin-top: 4px;
            display: block;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 5px;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: var(--accent-color);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 18px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-complete {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.2);
        }

        .btn-tomorrow {
            background: #eee;
            color: #888;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .form-group {
            text-align: left;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 1rem;
            color: var(--text-main);
            background: var(--card-bg);
        }

        .form-inline {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.4);
            font-size: 2rem;
            cursor: pointer;
            z-index: 100;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }
    </style>
</head>

<body>
    <header>
        <h1>
            <span>ÂÆ∂‰∫ã„ÅÆ„Äå„ÅÑ„Å§„Å†„Å£„ÅëÔºü„Äç</span>
            <span class="title-sub">Ëß£Ê±∫„Åè„Çì</span>
        </h1>
        <p class="subtitle" id="dynamic-subtitle">Âøò„Çå„Å¶„ÇÇÂ§ß‰∏àÂ§´„ÄÅ„ÅÇ„Å™„Åü„ÅØÊØéÊó•È†ëÂºµ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ ‚ú®</p>
        <div class="controls">
            <button class="icon-btn" onclick="setTheme('soft')" id="theme-soft" title="„Åµ„Çì„Çè„Çä">‚òÄÔ∏è</button>
            <button class="icon-btn" onclick="setTheme('calm')" id="theme-calm" title="ËêΩ„Å°ÁùÄ„Åç">üåô</button>
            <button class="icon-btn" onclick="setTheme('natural')" id="theme-natural" title="„Éä„ÉÅ„É•„É©„É´">üåø</button>
            <button class="icon-btn" onclick="toggleNotifications()" id="notif-btn" title="ÈÄöÁü•Ë®≠ÂÆö">üîî</button>
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" id="tab-today" onclick="switchView('today')">„ÇÑ„Çã„Åì„Å®</div>
            <div class="nav-tab" id="tab-dashboard" onclick="switchView('dashboard')">Ë®≠ÂÆö‰∏ÄË¶ß</div>
        </div>
    </header>

    <div class="container">
        <div id="view-today" class="view active">
            <div id="today-list" class="task-list"></div>
        </div>
        <div id="view-dashboard" class="view">
            <div id="dashboard-list" class="task-list"></div>
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn-tomorrow" style="width: auto; padding: 12px 24px; font-size: 0.8rem; opacity: 0.7;"
                    onclick="resetTasks()">ÂàùÊúüË®≠ÂÆöÔºà20È†ÖÁõÆÔºâ„Å´Êàª„Åô</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="feedback-overlay" class="modal-overlay" onclick="closeModal('feedback-overlay')">
        <div class="modal-content slide-up" onclick="event.stopPropagation()">
            <p id="praise-text"
                style="font-size: 1.4rem; color: var(--accent-color); font-weight: bold; margin-bottom: 10px;"></p>
            <p style="margin-bottom: 25px;">„Åì„Çå„Åß„Åæ„ÅüÂÆ∂Êóè„ÅåÂø´ÈÅ©„Å´ÈÅé„Åî„Åõ„Åæ„Åô„Å≠ ‚ò∫Ô∏è</p>
            <button class="btn-complete" onclick="closeModal('feedback-overlay')">„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ</button>
        </div>
    </div>

    <div id="add-modal" class="modal-overlay">
        <div class="modal-content slide-up">
            <h2 style="color: var(--accent-color); margin-top: 0;">Êñ∞„Åó„ÅÑÂÆ∂‰∫ã„ÇíËøΩÂä†</h2>
            <div class="form-group">
                <label>ÂÆ∂‰∫ã„ÅÆÂêçÂâç</label>
                <input type="text" id="new-task-name" placeholder="‰æãÔºö„Éà„Ç§„É¨„ÅÆÂ±§Ê¥óÊµÑ">
            </div>
            <div class="form-group">
                <label>Áπ∞„ÇäËøî„ÅôÂë®Êúü</label>
                <div class="form-inline">
                    <input type="number" id="new-task-value" value="1" min="1" max="99" style="flex:1;">
                    <select id="new-task-unit" style="flex:1.5;">
                        <option value="days">Êó•„Åä„Åç</option>
                        <option value="weeks" selected>ÈÄ±Èñì„Åä„Åç</option>
                        <option value="months">„É∂Êúà„Åä„Åç</option>
                        <option value="years">Âπ¥„Åä„Åç</option>
                    </select>
                </div>
                <span class="guide-text" id="add-guide"></span>
            </div>
            <button class="btn-complete" onclick="addTask()">‰øùÂ≠ò„Åô„Çã</button>
            <button class="btn-tomorrow" style="margin-top:10px;" onclick="closeModal('add-modal')">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <div class="fab" id="fab-plus" onclick="showModal('add-modal')">+</div>

    <script>
        const STANDARD_GUIDES = {
            'ÊµÑÊ∞¥Âô®': { val: 4, unit: 'months', text: '4„É∂Êúà' },
            'Ë£ΩÊ∞∑Ê©ü': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            'È£üÊ¥óÊ©ü': { val: 1, unit: 'weeks', text: '1ÈÄ±Èñì' },
            'ÊèõÊ∞óÊâá': { val: 2, unit: 'months', text: '2„É∂Êúà' },
            'ÂÜ∑ËîµÂ∫´': { val: 6, unit: 'months', text: '6„É∂Êúà' },
            'Èò≤„Ç´„Éì': { val: 2, unit: 'months', text: '2„É∂Êúà' },
            'ÊéíÊ∞¥Ê∫ù': { val: 1, unit: 'weeks', text: '1ÈÄ±Èñì' },
            'Ê¥óÊøØÊßΩ': { val: 2, unit: 'months', text: '2„É∂Êúà' },
            'ÈÄöÊ∞óÂè£': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            '„Éà„Ç§„É¨': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            '„Ç®„Ç¢„Ç≥„É≥': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            'Á©∫Ê∞óÊ∏ÖÊµÑÊ©ü': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            'Âä†ÊπøÂô®': { val: 2, unit: 'weeks', text: '2ÈÄ±Èñì' },
            'ÊéÉÈô§Ê©ü': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            '„Ç´„Éº„ÉÜ„É≥': { val: 6, unit: 'months', text: '6„É∂Êúà' },
            '„Ç™„Ç§„É´': { val: 6, unit: 'months', text: '6„É∂Êúà' },
            'Ê¥óËªä': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            'Ëá™Ëª¢Ëªä': { val: 1, unit: 'months', text: '1„É∂Êúà' },
            'ÁÅ´ÁÅΩÂ†±Áü•Âô®': { val: 1, unit: 'years', text: '1Âπ¥' },
            'Èò≤ÁÅΩ': { val: 1, unit: 'years', text: '1Âπ¥' }
        };

        const INITIAL_PRESETS = [
            { id: 101, name: 'ÊµÑÊ∞¥Âô®„Ç´„Éº„Éà„É™„ÉÉ„Ç∏‰∫§Êèõ', category: '„Ç≠„ÉÉ„ÉÅ„É≥', val: 4, unit: 'months', advice: 'ÁæéÂë≥„Åó„ÅÑ„ÅäÊ∞¥„ÅÆ„Åü„ÇÅ„Å´', order: 1 },
            { id: 102, name: 'Ë£ΩÊ∞∑Ê©ü„ÅÆÁµ¶Ê∞¥„Çø„É≥„ÇØÊéÉÈô§', category: '„Ç≠„ÉÉ„ÉÅ„É≥', val: 1, unit: 'months', advice: '„ÅäÊ∞∑„ÇÇÊ∏ÖÊΩî„Åå‰∏ÄÁï™„Åß„Åô„Å≠', order: 2 },
            { id: 103, name: 'È£üÊ¥óÊ©ü„Éï„Ç£„É´„Çø„ÉºÊéÉÈô§', category: '„Ç≠„ÉÉ„ÉÅ„É≥', val: 1, unit: 'weeks', advice: 'Ê∫ú„Åæ„Å£„ÅüÊ±ö„Çå„Çí„Çπ„ÉÉ„Ç≠„É™ËêΩ„Å®„Åó„Åæ„Åó„Çá„ÅÜ', order: 3 },
            { id: 104, name: 'ÊèõÊ∞óÊâá„Éï„Ç£„É´„Çø„Éº‰∫§Êèõ', category: '„Ç≠„ÉÉ„ÉÅ„É≥', val: 2, unit: 'months', advice: '„Éô„Çø„Å§„Åç„ÅåÊ∫ú„Åæ„ÇãÂâç„Å´', order: 4 },
            { id: 105, name: 'ÂÜ∑ËîµÂ∫´„ÅÆËÑ±Ëá≠Ââ§‰∫§Êèõ', category: '„Ç≠„ÉÉ„ÉÅ„É≥', val: 6, unit: 'months', advice: 'Èñã„Åë„Çã„Åü„Å≥ÁàΩ„ÇÑ„Åã„Å´', order: 5 },
            { id: 201, name: '„ÅäÈ¢®ÂëÇ„ÅÆÈò≤„Ç´„Éì„Åè„ÇìÁÖôÂâ§', category: 'Ê∞¥Âõû„Çä', val: 2, unit: 'months', advice: '„Ç´„Éì„Åï„Çì„Çµ„É®„Éä„É©üåø', order: 6 },
            { id: 202, name: 'ÊéíÊ∞¥Ê∫ù„Éç„ÉÉ„Éà„ÅÆÂÆöÊúü‰∫§Êèõ', category: 'Ê∞¥Âõû„Çä', val: 1, unit: 'weeks', advice: '„Éå„É°„É™„ÇíÈò≤„ÅÑ„ÅßÊ∏ÖÊΩî„Å´', order: 7 },
            { id: 203, name: 'Ê¥óÊøØÊßΩ„ÇØ„É™„Éº„Éä„ÉºÊéÉÈô§', category: 'Ê∞¥Âõû„Çä', val: 2, unit: 'months', advice: '„ÅäÊ¥ãÊúç„ÇÇÂñú„Å≥„Åæ„Åô', order: 8 },
            { id: 204, name: '„ÅäÈ¢®ÂëÇ„ÅÆÈÄöÊ∞óÂè£„Éõ„Ç≥„É™Âèñ„Çä', category: 'Ê∞¥Âõû„Çä', val: 1, unit: 'months', advice: 'Á©∫Ê∞ó„ÅÆÈÄö„ÇäÈÅì„Çí„Ç≠„É¨„Ç§„Å´', order: 9 },
            { id: 205, name: '„Éà„Ç§„É¨„ÅÆËÑ±Ëá≠„Éï„Ç£„É´„Çø„ÉºÊéÉÈô§', category: 'Ê∞¥Âõû„Çä', val: 1, unit: 'months', advice: 'Ë¶ã„Åà„Å™„ÅÑÂ†¥ÊâÄ„Åª„Å©Â§ßÂàá„Å´', order: 10 },
            { id: 301, name: '„Ç®„Ç¢„Ç≥„É≥„Éï„Ç£„É´„Çø„ÉºÊéÉÈô§', category: '„É™„Éì„É≥„Ç∞', val: 1, unit: 'months', advice: 'ÂÖâÁÜ±Ë≤ª„ÅÆÁØÄÁ¥Ñ„Å´„ÇÇ„Å§„Å™„Åå„Çä„Åæ„Åô„Çà', order: 11 },
            { id: 302, name: 'Á©∫Ê∞óÊ∏ÖÊµÑÊ©ü„Éï„Ç£„É´„Çø„ÉºÊéÉÈô§', category: '„É™„Éì„É≥„Ç∞', val: 1, unit: 'months', advice: '„Åç„Çå„ÅÑ„Å™Á©∫Ê∞ó„Åß„É™„É©„ÉÉ„ÇØ„Çπ', order: 12 },
            { id: 303, name: 'Âä†ÊπøÂô®„Éà„É¨„Éº„Éª„Éï„Ç£„É´„Çø„ÉºÊéÉÈô§', category: '„É™„Éì„É≥„Ç∞', val: 2, unit: 'weeks', advice: 'Ê∞¥Âû¢„ÇíÈò≤„ÅÑ„ÅßÊΩ§„ÅÑ„Ç≠„Éº„Éó', order: 13 },
            { id: 304, name: 'ÊéÉÈô§Ê©ü„Éï„Ç£„É´„Çø„ÉºÊéÉÈô§', category: '„É™„Éì„É≥„Ç∞', val: 1, unit: 'months', advice: 'Âê∏ÂºïÂäõ„ÇíÁ∂≠ÊåÅ„Åó„Åæ„Åó„Çá„ÅÜ', order: 14 },
            { id: 305, name: '„Ç´„Éº„ÉÜ„É≥„ÅÆÊ¥óÊøØ', category: '„É™„Éì„É≥„Ç∞', val: 6, unit: 'months', advice: '„ÅäÈÉ®Â±ã„Åå„Éë„ÉÉ„Å®Êòé„Çã„Åè„Å™„Çä„Åæ„Åô', order: 15 },
            { id: 401, name: 'Ëªä„ÅÆ„Ç™„Ç§„É´‰∫§Êèõ', category: 'Â§ñÂõû„Çä', val: 6, unit: 'months', advice: 'ÊÑõËªä„ÇÇÈï∑„ÅèÂ§ßÂàá„Å´', order: 16 },
            { id: 402, name: 'Ëªä„ÅÆÊ¥óËªä', category: 'Â§ñÂõû„Çä', val: 1, unit: 'months', advice: '„Éî„Ç´„Éî„Ç´„Åß„Éâ„É©„Ç§„Éñ„ÇÇÊ•Ω„Åó„Åè', order: 17 },
            { id: 403, name: 'Ëá™Ëª¢Ëªä„ÅÆÁ©∫Ê∞óÂÖ•„Çå', category: 'Â§ñÂõû„Çä', val: 1, unit: 'months', advice: '„Çπ„Ç§„Çπ„Ç§ÈÄ≤„Çì„ÅßÂø´ÈÅ©„Å´', order: 18 },
            { id: 404, name: 'ÁÅ´ÁÅΩÂ†±Áü•Âô®„ÅÆÁÇπÊ§ú', category: 'Èò≤ÁÅΩ', val: 1, unit: 'years', advice: 'ÂÆ∂Êóè„ÅÆÂÆâÂÖ®„ÇíÈ°ò„Å£„Å¶', order: 19 },
            { id: 405, name: 'Èò≤ÁÅΩ„É™„É•„ÉÉ„ÇØ„ÅÆÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ', category: 'Èò≤ÁÅΩ', val: 1, unit: 'years', advice: 'ÂÇô„Åà„ÅÇ„Çå„Å∞ÊÜÇ„ÅÑ„Å™„Åó„Åß„Åô„Å≠', order: 20 }
        ];

        let tasks = JSON.parse(localStorage.getItem('houseworkTasks')) || INITIAL_PRESETS.map(p => ({
            ...p, lastDone: null, nextDue: new Date().toISOString()
        }));

        // Migrating old tasks that only have intervalWeeks
        tasks = tasks.map(t => {
            if (t.intervalWeeks && !t.unit) {
                t.val = t.intervalWeeks;
                t.unit = 'weeks';
                delete t.intervalWeeks;
            }
            return t;
        });

        let currentTheme = localStorage.getItem('houseworkTheme') || 'soft';
        let currentView = 'today';

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            currentTheme = theme; localStorage.setItem('houseworkTheme', theme);
            document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`theme-${theme}`).classList.add('active');
        }

        async function toggleNotifications() {
            alert('ÈÄöÁü•Ê©üËÉΩ„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åè„Å®„ÄÅ‰ªäÂæå„ÅÆ„Ç¢„ÉÉ„Éó„Éá„Éº„Éà„ÅßÂØæÂøú‰∫àÂÆö„Åß„Åô‚ò∫Ô∏è');
        }

        function switchView(viewName) {
            currentView = viewName;
            document.getElementById('tab-today').classList.toggle('active', viewName === 'today');
            document.getElementById('tab-dashboard').classList.toggle('active', viewName === 'dashboard');
            document.getElementById('view-today').classList.toggle('active', viewName === 'today');
            document.getElementById('view-dashboard').classList.toggle('active', viewName === 'dashboard');
            document.getElementById('dynamic-subtitle').innerText = (viewName === 'today') ?
                "Âøò„Çå„Å¶„ÇÇÂ§ß‰∏àÂ§´„ÄÅ„ÅÇ„Å™„Åü„ÅØÊØéÊó•È†ëÂºµ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ ‚ú®" : "ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÂÆ∂‰∫ã„ÅÆ‰∏ÄË¶ß„Åß„Åô„ÄÇ„ÅÑ„Å§„Åß„ÇÇË™øÊï¥„Åß„Åç„Åæ„Åô üåø";
            document.getElementById('fab-plus').style.display = (viewName === 'today') ? 'flex' : 'none';
            render();
        }

        function calculateNextDue(lastDoneStr, val, unit) {
            const base = lastDoneStr ? new Date(lastDoneStr) : new Date();
            const next = new Date(base);
            const num = parseInt(val);
            if (unit === 'days') next.setDate(next.getDate() + num);
            else if (unit === 'weeks') next.setDate(next.getDate() + (num * 7));
            else if (unit === 'months') next.setMonth(next.getMonth() + num);
            else if (unit === 'years') next.setFullYear(next.getFullYear() + num);
            return next.toISOString();
        }

        function render() {
            const listId = (currentView === 'today') ? 'today-list' : 'dashboard-list';
            const list = document.getElementById(listId); list.innerHTML = '';
            const filtered = (currentView === 'today') ? tasks.filter(t => new Date(t.nextDue) <= new Date()) : tasks;
            if (filtered.length === 0 && currentView === 'today') list.innerHTML = '<div style="text-align:center; padding:50px; opacity:0.6;">‰ªä„ÅØ„ÇÑ„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„ÇÜ„Å£„Åè„Çä‰ºë„Çì„Åß„Åè„Å†„Åï„ÅÑ„Å≠ üçµ</div>';
            else filtered.sort((a, b) => a.order - b.order).forEach(t => list.appendChild(createCard(t, currentView === 'today')));
            localStorage.setItem('houseworkTasks', JSON.stringify(tasks));
        }

        function formatIntervalText(val, unit) {
            const unitMap = { days: 'Êó•', weeks: 'ÈÄ±Èñì', months: '„É∂Êúà', years: 'Âπ¥' };
            return `${val}${unitMap[unit]}„Åä„Åç`;
        }

        function createCard(task, showActions) {
            const card = document.createElement('div'); card.className = 'task-card slide-up';
            const isDue = new Date(task.nextDue) <= new Date();
            const dateStr = new Date(task.nextDue).toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' });
            const guideKey = Object.keys(STANDARD_GUIDES).find(k => task.name.includes(k));
            const adviceText = task.advice || "„ÅîÂÆ∂Â∫≠„ÅÆ„Éö„Éº„Çπ„ÅßÂ§ß‰∏àÂ§´„Åß„Åô„Çà‚ò∫Ô∏è";
            const maxVal = task.unit === 'days' ? 31 : (task.unit === 'weeks' ? 52 : (task.unit === 'months' ? 24 : 10));

            card.innerHTML = `
                ${task.category ? `<span class="category-label">${task.category}</span>` : ''}
                <button class="btn-delete" onclick="deleteTask(${task.id})" title="ÂâäÈô§">üóëÔ∏è</button>
                <span class="task-name">${task.name}</span>
                <div class="task-meta">
                    Ê¨°ÂõûÁõÆÂÆâ: ${dateStr} 
                    <span class="status-badge ${isDue ? 'status-due' : 'status-future'}">${isDue ? '„Åù„Çç„Åù„Çç„Åã„Å™Ôºü' : '„Åæ„Å†ÂÖà„Åß„Åô'}</span>
                </div>
                <div class="advice-box">${adviceText}</div>
                ${!showActions ? `
                <div class="slider-section">
                    <div class="slider-label">
                        <span>Âë®Êúü„ÇíË™øÊï¥ ${guideKey ? `<span class="guide-text">Ê®ôÊ∫ñ: ${STANDARD_GUIDES[guideKey].text}</span>` : ''}</span>
                        <span class="slider-value" id="val-${task.id}">${formatIntervalText(task.val, task.unit)}</span>
                    </div>
                    <input type="range" min="1" max="${maxVal}" value="${task.val}" 
                        class="range-slider"
                        style="touch-action: pan-y; cursor: grab;"
                        oninput="updateInterval(${task.id}, this.value)" 
                        onchange="render()"
                        onpointerdown="event.stopPropagation()"
                        onpointermove="event.stopPropagation()"
                        ontouchstart="event.stopPropagation()" 
                        ontouchmove="event.stopPropagation()" 
                        ontouchend="event.stopPropagation()"
                        onmousedown="event.stopPropagation()">
                </div>` : `
                <div style="margin-top: 12px; font-size: 0.85rem; color: var(--accent-color); font-weight: bold;">
                    Âë®Êúü: ${formatIntervalText(task.val, task.unit)}
                </div>
                `}
                ${showActions ? `<div class="btn-group">
                    <button class="btn-complete" onclick="completeTask(${task.id})">„ÇÑ„Å£„Åü„ÇàÔºÅ</button>
                    <button class="btn-tomorrow" onclick="postponeTask(${task.id})">ÊòéÊó•„ÇÑ„Çã</button>
                </div>` : ''}`;
            return card;
        }

        function updateInterval(id, val) {
            const t = tasks.find(x => x.id === id);
            t.val = parseInt(val);
            t.nextDue = calculateNextDue(t.lastDone, t.val, t.unit);
            // Update only the label text immediately to avoid layout jumps
            const label = document.getElementById(`val-${id}`);
            if (label) label.innerText = formatIntervalText(t.val, t.unit);
            // State is saved in render() which is called on 'change'
        }

        function completeTask(id) {
            const t = tasks.find(x => x.id === id);
            t.lastDone = new Date().toISOString();
            t.nextDue = calculateNextDue(t.lastDone, t.val, t.unit);
            document.getElementById('praise-text').innerText = ["ÊúÄÈ´ò„Åß„Åô‚ú®", "Êï¥„ÅÑ„Åæ„Åó„Åüüåø", "Á¥†Êïµ„Åß„ÅôÔºÅ", "„ÅäÁñ≤„ÇåÊßò‚ò∫Ô∏è"][Math.floor(Math.random() * 4)];
            showModal('feedback-overlay'); render();
        }

        function postponeTask(id) {
            const t = tasks.find(x => x.id === id);
            const tmw = new Date(); tmw.setDate(tmw.getDate() + 1);
            t.nextDue = tmw.toISOString(); render();
        }

        function deleteTask(id) {
            if (confirm("Ê∂àÂéª„Åó„Åæ„Åô„Çà„ÄÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü")) {
                tasks = tasks.filter(t => t.id !== id);
                render();
            }
        }

        function showModal(id) {
            document.getElementById(id).style.display = 'flex';
            if (id === 'add-modal') {
                document.getElementById('new-task-name').oninput = e => {
                    const g = Object.keys(STANDARD_GUIDES).find(k => e.target.value.includes(k));
                    document.getElementById('add-guide').innerText = g ? `Ê®ôÊ∫ñÁõÆÂÆâ: ${STANDARD_GUIDES[g].text}` : '';
                };
            }
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function addTask() {
            const name = document.getElementById('new-task-name').value;
            const val = parseInt(document.getElementById('new-task-value').value);
            const unit = document.getElementById('new-task-unit').value;
            if (!name) return;
            const newTask = {
                id: Date.now(),
                name,
                val,
                unit,
                category: 'Ëá™ÂàÜÊµÅ',
                order: tasks.length + 1,
                lastDone: null,
                advice: '„ÅîÂÆ∂Â∫≠„ÅÆ„Éö„Éº„Çπ„ÅßÂ§ß‰∏àÂ§´„Åß„Åô„Çà‚ò∫Ô∏è'
            };
            newTask.nextDue = calculateNextDue(null, val, unit);
            tasks.push(newTask);
            closeModal('add-modal'); render();
        }

        function resetTasks() {
            if (confirm("ÂÆ∂‰∫ã„É™„Çπ„Éà„ÇíÂàùÊúüË®≠ÂÆöÔºà20È†ÖÁõÆÔºâ„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü\n‚Äª„ÅîËá™Ë∫´„ÅßËøΩÂä†„ÉªÂ§âÊõ¥„Åó„ÅüÂÜÖÂÆπ„ÅØÊ∂à„Åà„Å¶„Åó„Åæ„ÅÑ„Åæ„Åô„ÄÇ")) {
                localStorage.removeItem('houseworkTasks');
                location.reload();
            }
        }

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        // Final protection against any swipe/gesture interference
        ['touchstart', 'touchmove', 'touchend', 'pointerdown', 'pointermove'].forEach(evt => {
            document.addEventListener(evt, (e) => {
                if (e.target.classList && e.target.classList.contains('range-slider')) {
                    e.stopPropagation();
                }
            }, { passive: true });
        });

        setTheme(currentTheme); render();
    </script>
</body>

</html>